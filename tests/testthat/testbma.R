context("Test bma")

set.seed(123)

# Create data for testing
data <- data.frame(species = rep(letters, each = 50),
                   year = rep(1:50, length(letters)),
                   index = rnorm(n = 50 * length(letters), mean = 0, sd = 1),
                   se = runif(n = 50 * length(letters), min = 0.01, max = .1))
temp <- tempfile()

test_that("simple run", {
  
  # Run the Bayesian meta-analysis
  sink(temp)
  bma_indicator <- bma(data,
                       model = "smooth",
                       m.scale = "logit",
                       n.iter = 100,
                       seed = 123)
  sink()
  # test a data frame is returned..
  expect_is(bma_indicator, 'data.frame') 
  # it has the right elements ...
  expect_equal(names(bma_indicator),
               c("Year", "Index.Mprime", "lowerCI.Mprime", "upperCI.Mprime", 
                 "Index.M", "lowerCI.M", "upperCI.M"))
  # and the values are the same
  expect_equal(bma_indicator$Index.Mprime,
               c(100, 93.1465767464721, 89.3114218507984, 85.5949722505127, 
                 83.9430123481585, 81.7122675078106, 81.8167733236095, 82.7176213907474, 
                 83.3935699017243, 85.1826680239021, 86.3883832546833, 86.8605063852497, 
                 87.0319518142757, 86.5052174855781, 85.0451805248205, 84.7401918331028, 
                 84.9681235858301, 84.3467073945094, 84.4438554050815, 84.1907230954043, 
                 83.5201814440744, 83.5287837582316, 82.9231296876419, 82.4319186857621, 
                 83.3906397435168, 83.5515326766049, 83.4313022781406, 83.3486575572758, 
                 82.1637590219783, 81.0162205587243, 81.1844861945805, 80.2952402308285, 
                 78.7823884739663, 77.7885238732459, 77.3966745315161, 78.1227372536011, 
                 79.0582627468008, 80.3413200812947, 80.953936667349, 81.3779531999397, 
                 82.7174476819934, 84.660166060221, 87.2201788944389, 88.1572203767751, 
                 88.2189703244452, 89.4176030065389, 90.1433359905299, 90.8034570882722, 
                 92.0122644339251, 91.8501716477788), tolerance=1e-3)
  expect_equal(bma_indicator$Index.M,
               c(100, 93.7151859934056, 88.875900433918, 85.20094872192, 82.4765853212565, 
                 80.5376857944807, 79.2493211841401, 78.4870867450422, 78.1287961186731, 
                 78.0491399314556, 78.1351896369235, 78.3057925867868, 78.5114547241235, 
                 78.7318919099216, 78.9516941612148, 79.1455137994674, 79.2777836955814, 
                 79.3071750299046, 79.2089527032148, 78.9822255414714, 78.6497989645542, 
                 78.2481502176824, 77.8030174303428, 77.3257693887762, 76.814065732173, 
                 76.2659923256175, 75.6984596395346, 75.1477823779312, 74.66740771411, 
                 74.3057098446791, 74.0905727971162, 74.0299753705505, 74.11530034614, 
                 74.3394964938591, 74.704155847949, 75.219667467046, 75.9015707542142, 
                 76.7580360559506, 77.7869948130706, 78.9754033565609, 80.2991540237979, 
                 81.7234877505562, 83.2018612557898, 84.6750349752032, 86.076547229449, 
                 87.3386690915678, 88.3936477532576, 89.1746925343515, 89.6136824473334, 
                 89.6413004538255), tolerance=1e-3)
  expect_equal(bma_indicator$upperCI.Mprime,
               c(100, 100.912670097298, 97.9127659677016, 95.8499701178894, 
                 94.671316063692, 89.967762734754, 93.9463008307346, 91.8714213799306, 
                 93.5154825557029, 97.2103850587094, 100.604000942243, 98.284833857316, 
                 99.5794344914379, 100.058004589596, 96.023948265488, 93.9152620486179, 
                 92.8653040381579, 93.6033909233236, 91.3659011269288, 92.2840208179575, 
                 91.3889899929472, 95.6265216726726, 100.784686621884, 98.3937767294999, 
                 99.0346891492975, 98.5975993343305, 93.7589428156902, 94.0423242183192, 
                 90.0355125646069, 89.3574031716457, 88.5411398430671, 88.6128338294964, 
                 86.9089757554644, 85.9470043459705, 85.2854508468944, 87.5774486565996, 
                 86.1864430155758, 87.6080843176338, 88.2546335849038, 90.2893916629357, 
                 91.5802927032084, 93.6644725019474, 97.7541237492462, 100.40716888185, 
                 101.115243416602, 101.47662882825, 104.027283069311, 107.464620760871, 
                 111.656833538891, 116.888378869377), tolerance=1e-3)
  
})

test_that("degraded data", {

  data2 <- data
  # Add NAs to one year
  data2[5,c(3:4)] <- NA
  # Remove a year of data
  data2 <- data2[1:(nrow(data2)-1),]
  
  sink(temp)
  set.seed(123)
  bma_indicator <- bma(data2,
                       model = "smooth",
                       m.scale = "logit",
                       n.iter = 100,
                       seed = 123)
  sink()
  
  expect_is(bma_indicator, 'data.frame')
  
})  


test_that("model options", {
  
  # bma_indicator_det <- bma(data,
  #                      model = "smooth_det",
  #                      m.scale = "logit",
  #                      n.iter = 100,
  #                      seed = 123)
  # 
  # # test a data frame is returned..
  # expect_is(bma_indicator_det, 'data.frame') 
  # # it has the right elements ...
  # expect_equal(names(bma_indicator_det),
  #              c("Year", "Index.Mprime", "lowerCI.Mprime", "upperCI.Mprime", 
  #                "Index.M", "lowerCI.M", "upperCI.M"))
  
  sink(temp)
  bma_indicator_smooth_det2 <- bma(data,
                       model = "smooth_det2",
                       m.scale = "logit",
                       n.iter = 100,
                       seed = 123)
  sink()
  
  # test a data frame is returned..
  expect_is(bma_indicator_smooth_det2, 'data.frame')
  # it has hte right elements ...
  expect_equal(names(bma_indicator_smooth_det2),
               c("Year", "Index.Mprime", "lowerCI.Mprime", "upperCI.Mprime",
                 "Index.M", "lowerCI.M", "upperCI.M"))
  expect_equal(bma_indicator_smooth_det2$Index.M,
               c(100, 95.93909090935, 92.7672496713464, 90.3009486772026, 88.3910564873888, 
                 86.9135156978769, 85.762962294484, 84.8485307419185, 84.0907145192179, 
                 83.419528497586, 82.7801742540728, 82.1397126378509, 81.4865697868186, 
                 80.8283760531123, 80.1769336841978, 79.5395128209959, 78.918912999682, 
                 78.3155809591785, 77.7374190089791, 77.2025558362917, 76.7390450389058, 
                 76.3828846793717, 76.173517902885, 76.1536897880308, 76.3699821598276, 
                 76.8573692438152, 77.6172261446705, 78.6144721564787, 79.7775852704348, 
                 81.0389454212986, 82.367518378779, 83.7723498196311, 85.3012594012114, 
                 87.0137904449635, 88.9705565936254, 91.2341498812796, 93.8627067415033, 
                 96.8850398226239, 100.290874956475, 104.023304761472, 107.984525783209, 
                 112.054621420101, 116.091278710721, 119.928865688976, 123.379833426503, 
                 126.238820288326, 128.289739888977, 129.315919102855, 129.111127561621, 
                 127.494892855453))
  
  sink(temp)
  bma_indicatorsmooth_det_sigtheta <- bma(data,
                       model = "smooth_det_sigtheta",
                       m.scale = "logit",
                       n.iter = 100,
                       seed = 123)
  sink()
  
  # test a data frame is returned..
  expect_is(bma_indicatorsmooth_det_sigtheta, 'data.frame')
  # it has the right elements ...
  expect_equal(names(bma_indicatorsmooth_det_sigtheta),
               c("Year", "Index.Mprime", "lowerCI.Mprime", "upperCI.Mprime",
                 "Index.M", "lowerCI.M", "upperCI.M"))
  expect_equal(bma_indicatorsmooth_det_sigtheta$Index.M,
               c(100, 95.1066424835543, 91.3277245037226, 88.4678784823851, 
                 86.3749875308697, 84.9289578315946, 84.0282642314814, 83.5732818349891, 
                 83.4603232794704, 83.5779762787929, 83.8203922311029, 84.1037927653868, 
                 84.3668218409477, 84.5704470720489, 84.6949304070813, 84.7380799523458, 
                 84.7153660145554, 84.6562107839785, 84.5854974146199, 84.5177530126733, 
                 84.4571762815342, 84.3988976106347, 84.3321081506402, 84.2405725547339, 
                 84.1028316496622, 83.8984447989557, 83.6163659513033, 83.2555068082075, 
                 82.8247269865824, 82.3445098974237, 81.8479674471805, 81.3803882658224, 
                 80.9967396195252, 80.7479373177327, 80.6761690900314, 80.8158186574453, 
                 81.1918701375337, 81.8126218286924, 82.6678619340919, 83.7277504340206, 
                 84.9432933084802, 86.248127439241, 87.5568964352754, 88.7643412067508, 
                 89.7566668063039, 90.4240705821149, 90.6646901541542, 90.3880341473998, 
                 89.5124407395943, 87.9667954932412))
  
})

test_that("different parameters", {
  
  sink(temp)
  # test reading se and indexing
  bma_indicator_params1 <- bma(data,
                               model = "smooth",
                               m.scale = "logit",
                               n.iter = 100,
                               seFromData = TRUE,
                               rescale_indices = 2,
                               rescaleYr = 5,
                               baseline = 10,
                               incl.2deriv = TRUE,
                               seed = 123)

  sink()
  
  expect_equal(bma_indicator_params1$Index.Mprime[5], 10)
  expect_equal(bma_indicator_params1$lowerCI.Mprime[5], 10)
  expect_equal(bma_indicator_params1$upperCI.Mprime[5], 10)
  
  sink(temp)
  # test reading se
  bma_indicator_params2 <- bma(data,
                               model = "smooth",
                               m.scale = "logit",
                               n.iter = 100, 
                               Y1perfect = FALSE,
                               seed = 123)
  sink()
  expect_is(bma_indicator_params2, 'data.frame')
  
})